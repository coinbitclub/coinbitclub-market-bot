// ========================================
// MARKETBOT - VALIDA√á√ÉO ROBUSTA SPRINTS 1-5
// Script com fallback para valida√ß√£o offline
// ========================================

const { Client } = require('pg');
const fs = require('fs');
const path = require('path');

// M√∫ltiplas configura√ß√µes de conex√£o para tentar
const DB_CONFIGS = [
  {
    name: 'Railway SSL',
    config: {
      host: 'junction.proxy.rlwy.net',
      port: 52299,
      database: 'railway',
      user: 'postgres',
      password: 'mKCaVaWXOlPLUjjOEgEKzpjjVuDAVxfY',
      ssl: { rejectUnauthorized: false },
      connectionTimeoutMillis: 10000
    }
  },
  {
    name: 'Railway Direct',
    config: {
      host: 'junction.proxy.rlwy.net',
      port: 52299,
      database: 'railway',
      user: 'postgres',
      password: 'mKCaVaWXOlPLUjjOEgEKzpjjVuDAVxfY',
      ssl: false,
      connectionTimeoutMillis: 15000
    }
  },
  {
    name: 'Railway ConnectionString',
    config: {
      connectionString: 'postgresql://postgres:mKCaVaWXOlPLUjjOEgEKzpjjVuDAVxfY@junction.proxy.rlwy.net:52299/railway',
      ssl: false,
      connectionTimeoutMillis: 20000
    }
  }
];

class RobustSprintValidator {
  constructor() {
    this.client = null;
    this.connected = false;
    this.validationMode = 'HYBRID'; // ONLINE, OFFLINE, HYBRID
    this.results = {
      sprint1: { score: 0, max: 100, details: [], mode: 'OFFLINE' },
      sprint2: { score: 0, max: 100, details: [], mode: 'OFFLINE' },
      sprint3: { score: 0, max: 100, details: [], mode: 'OFFLINE' },
      sprint4: { score: 0, max: 100, details: [], mode: 'OFFLINE' },
      sprint5: { score: 0, max: 100, details: [], mode: 'OFFLINE' },
      overall: { score: 0, max: 500 }
    };
  }

  async connect() {
    console.log('üîó Tentando m√∫ltiplas configura√ß√µes de conex√£o...');
    
    for (const dbConfig of DB_CONFIGS) {
      try {
        console.log(`‚ö° Testando: ${dbConfig.name}...`);
        
        this.client = new Client(dbConfig.config);
        
        const connectPromise = this.client.connect();
        const timeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), dbConfig.config.connectionTimeoutMillis || 10000)
        );
        
        await Promise.race([connectPromise, timeout]);
        
        // Testar query simples
        const result = await this.client.query('SELECT version() as v, NOW() as t');
        console.log(`‚úÖ Conectado com ${dbConfig.name}`);
        console.log(`üìä ${result.rows[0].v.split(' ')[0]} | ${result.rows[0].t}`);
        
        this.connected = true;
        this.validationMode = 'ONLINE';
        return true;
        
      } catch (error) {
        console.log(`‚ùå ${dbConfig.name} falhou: ${error.message}`);
        if (this.client) {
          try { await this.client.end(); } catch(e) {}
          this.client = null;
        }
      }
    }
    
    console.log('‚ö†Ô∏è Nenhuma conex√£o funcionou. Executando valida√ß√£o OFFLINE...');
    this.validationMode = 'OFFLINE';
    return false;
  }

  async disconnect() {
    if (this.client) {
      try {
        await this.client.end();
        console.log('üîå Conex√£o encerrada');
      } catch (error) {
        console.log('‚ö†Ô∏è Erro ao encerrar conex√£o:', error.message);
      }
    }
  }

  // ========================================
  // VALIDA√á√ÉO OFFLINE (ESTRUTURA DE ARQUIVOS)
  // ========================================
  validateOffline() {
    console.log('\nüîç EXECUTANDO VALIDA√á√ÉO OFFLINE - ESTRUTURA DE ARQUIVOS');
    console.log('=======================================================');

    // Sprint 1 - Arquivos cr√≠ticos
    this.validateSprint1Offline();
    this.validateSprint2Offline();
    this.validateSprint3Offline();
    this.validateSprint4Offline();
    this.validateSprint5Offline();

    return this.generateFinalReport();
  }

  validateSprint1Offline() {
    console.log('\nüìÅ SPRINT 1 - Valida√ß√£o de Arquivos');
    let score = 0;
    const details = [];

    // Verificar arquivos cr√≠ticos
    const criticalFiles = [
      { file: 'src/services/database.service.ts', points: 20 },
      { file: 'src/services/coupon.service.ts', points: 20 },
      { file: 'src/services/auth.service.ts', points: 15 },
      { file: 'migrations/005_stripe_financial_system.sql', points: 25 },
      { file: 'tests/integration/database.integration.test.ts', points: 10 },
      { file: 'tests/unit/coupon.service.test.ts', points: 10 }
    ];

    for (const { file, points } of criticalFiles) {
      if (fs.existsSync(path.join(process.cwd(), file))) {
        score += points;
        details.push(`‚úÖ ${file} (${points} pts)`);
      } else {
        details.push(`‚ùå ${file} N√ÉO encontrado (${points} pts perdidos)`);
      }
    }

    this.results.sprint1 = { score, max: 100, details, mode: 'OFFLINE' };
    console.log(`Sprint 1: ${score}/100 pontos`);
  }

  validateSprint2Offline() {
    console.log('\nüí∞ SPRINT 2 - Sistema Financeiro');
    let score = 0;
    const details = [];

    const financialFiles = [
      { file: 'src/services/commission.service.ts', points: 30 },
      { file: 'src/services/withdrawal.service.ts', points: 30 },
      { file: 'src/services/stripe-webhook.service.ts', points: 25 },
      { file: 'migrations/008_withdrawal_system.sql', points: 15 }
    ];

    for (const { file, points } of financialFiles) {
      if (fs.existsSync(path.join(process.cwd(), file))) {
        score += points;
        details.push(`‚úÖ ${file} (${points} pts)`);
      } else {
        details.push(`‚ùå ${file} N√ÉO encontrado (${points} pts perdidos)`);
      }
    }

    this.results.sprint2 = { score, max: 100, details, mode: 'OFFLINE' };
    console.log(`Sprint 2: ${score}/100 pontos`);
  }

  validateSprint3Offline() {
    console.log('\nüîê SPRINT 3 - Seguran√ßa Enterprise');
    let score = 0;
    const details = [];

    const securityFiles = [
      { file: 'src/services/two-factor-auth.service.ts', points: 40 },
      { file: 'src/services/security-lockout.service.ts', points: 30 },
      { file: 'src/middleware/security.middleware.ts', points: 20 },
      { file: 'migrations/011_two_factor_system.sql', points: 10 }
    ];

    for (const { file, points } of securityFiles) {
      if (fs.existsSync(path.join(process.cwd(), file))) {
        score += points;
        details.push(`‚úÖ ${file} (${points} pts)`);
      } else {
        details.push(`‚ùå ${file} N√ÉO encontrado (${points} pts perdidos)`);
      }
    }

    this.results.sprint3 = { score, max: 100, details, mode: 'OFFLINE' };
    console.log(`Sprint 3: ${score}/100 pontos`);
  }

  validateSprint4Offline() {
    console.log('\nüìä SPRINT 4 - Dashboard e Monitoramento');
    let score = 0;
    const details = [];

    const dashboardFiles = [
      { file: 'src/services/dashboard.service.ts', points: 35 },
      { file: 'src/services/websocket.service.ts', points: 25 },
      { file: 'src/routes/dashboard.routes.ts', points: 25 },
      { file: 'migrations/013_monitoring_system.sql', points: 15 }
    ];

    for (const { file, points } of dashboardFiles) {
      if (fs.existsSync(path.join(process.cwd(), file))) {
        score += points;
        details.push(`‚úÖ ${file} (${points} pts)`);
      } else {
        details.push(`‚ùå ${file} N√ÉO encontrado (${points} pts perdidos)`);
      }
    }

    this.results.sprint4 = { score, max: 100, details, mode: 'OFFLINE' };
    console.log(`Sprint 4: ${score}/100 pontos`);
  }

  validateSprint5Offline() {
    console.log('\n‚öôÔ∏è SPRINT 5 - Trading Engine Enterprise');
    let score = 0;
    const details = [];

    const tradingFiles = [
      { file: 'src/services/trading-configuration.service.ts', points: 35 },
      { file: 'src/services/trading-queue-simple.service.ts', points: 35 },
      { file: 'src/routes/trading.routes.ts', points: 20 },
      { file: 'migrations/005_trading_system_complete.sql', points: 10 }
    ];

    for (const { file, points } of tradingFiles) {
      if (fs.existsSync(path.join(process.cwd(), file))) {
        score += points;
        details.push(`‚úÖ ${file} (${points} pts)`);
        
        // Verifica√ß√£o adicional do conte√∫do
        try {
          const content = fs.readFileSync(path.join(process.cwd(), file), 'utf8');
          if (content.length > 1000) { // Arquivo substancial
            details.push(`  üí° Arquivo com implementa√ß√£o substancial (${Math.round(content.length/1000)}k chars)`);
          }
        } catch (e) {
          details.push(`  ‚ö†Ô∏è Erro lendo conte√∫do do arquivo`);
        }
      } else {
        details.push(`‚ùå ${file} N√ÉO encontrado (${points} pts perdidos)`);
      }
    }

    this.results.sprint5 = { score, max: 100, details, mode: 'OFFLINE' };
    console.log(`Sprint 5: ${score}/100 pontos`);
  }

  // ========================================
  // VALIDA√á√ÉO ONLINE (COM BANCO)
  // ========================================
  async validateOnline() {
    console.log('\nüîó EXECUTANDO VALIDA√á√ÉO ONLINE - BANCO DE DADOS');
    console.log('===============================================');

    // Primeiro fazer valida√ß√£o offline
    this.validateOffline();

    // Depois complementar com dados do banco
    await this.validateDatabaseTables();
    await this.validateDatabaseData();

    return this.generateFinalReport();
  }

  async validateDatabaseTables() {
    if (!this.connected) return;

    console.log('\nüóÑÔ∏è Validando Tabelas do Banco');
    
    const expectedTables = [
      'users', 'coupons', 'stripe_customers', 'stripe_subscriptions',
      'commissions', 'withdrawals', 'user_2fa', 'blocked_ips',
      'system_metrics', 'system_alerts', 'trading_configurations',
      'trading_queue', 'trading_positions'
    ];

    try {
      const result = await this.client.query(`
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public'
        ORDER BY table_name
      `);

      const existingTables = result.rows.map(row => row.table_name);
      
      console.log(`üìä Tabelas encontradas: ${existingTables.length}`);
      
      for (const table of expectedTables) {
        if (existingTables.includes(table)) {
          console.log(`‚úÖ ${table}`);
        } else {
          console.log(`‚ùå ${table} (N√ÉO ENCONTRADA)`);
        }
      }

      const coverage = (existingTables.filter(t => expectedTables.includes(t)).length / expectedTables.length) * 100;
      console.log(`üìà Cobertura de tabelas: ${Math.round(coverage)}%`);

    } catch (error) {
      console.log(`‚ùå Erro validando tabelas: ${error.message}`);
    }
  }

  async validateDatabaseData() {
    if (!this.connected) return;

    console.log('\nüìä Validando Dados do Banco');
    
    try {
      // Verificar configura√ß√µes padr√£o
      const configs = await this.client.query('SELECT COUNT(*) FROM trading_configurations');
      console.log(`‚úÖ Configura√ß√µes trading: ${configs.rows[0].count}`);

      // Verificar usu√°rios
      const users = await this.client.query('SELECT COUNT(*) FROM users');
      console.log(`üë• Usu√°rios cadastrados: ${users.rows[0].count}`);

      // Verificar cupons
      const coupons = await this.client.query('SELECT COUNT(*) FROM coupons');
      console.log(`üé´ Cupons dispon√≠veis: ${coupons.rows[0].count}`);

    } catch (error) {
      console.log(`‚ùå Erro validando dados: ${error.message}`);
    }
  }

  // ========================================
  // RELAT√ìRIO FINAL ROBUSTO
  // ========================================
  generateFinalReport() {
    console.log('\n\nüéØ RELAT√ìRIO FINAL DE VALIDA√á√ÉO');
    console.log('===============================');
    
    const totalScore = this.results.sprint1.score + this.results.sprint2.score + 
                       this.results.sprint3.score + this.results.sprint4.score + 
                       this.results.sprint5.score;
    
    this.results.overall = { score: totalScore, max: 500 };
    const percentage = Math.round((totalScore / 500) * 100);

    console.log(`\nüìä RESULTADOS POR SPRINT (Modo: ${this.validationMode}):`);
    console.log(`Sprint 1 (Corre√ß√µes): ${this.results.sprint1.score}/100 ${this.getStatusIcon(this.results.sprint1.score)}`);
    console.log(`Sprint 2 (Financeiro): ${this.results.sprint2.score}/100 ${this.getStatusIcon(this.results.sprint2.score)}`);
    console.log(`Sprint 3 (Seguran√ßa): ${this.results.sprint3.score}/100 ${this.getStatusIcon(this.results.sprint3.score)}`);
    console.log(`Sprint 4 (Dashboard): ${this.results.sprint4.score}/100 ${this.getStatusIcon(this.results.sprint4.score)}`);
    console.log(`Sprint 5 (Trading): ${this.results.sprint5.score}/100 ${this.getStatusIcon(this.results.sprint5.score)}`);
    
    console.log(`\nüéØ PONTUA√á√ÉO TOTAL: ${totalScore}/500 (${percentage}%)`);
    
    // Status baseado na pontua√ß√£o
    let status, emoji, message;
    if (percentage >= 90) {
      status = 'EXCELENTE'; emoji = 'üèÜ'; 
      message = 'Sistema pronto para produ√ß√£o enterprise!';
    } else if (percentage >= 80) {
      status = 'BOM'; emoji = '‚úÖ'; 
      message = 'Sistema quase pronto, pequenos ajustes necess√°rios';
    } else if (percentage >= 70) {
      status = 'PARCIAL'; emoji = '‚ö†Ô∏è'; 
      message = 'Sistema funcional mas precisa de melhorias';
    } else {
      status = 'CR√çTICO'; emoji = '‚ùå'; 
      message = 'Sistema precisa de corre√ß√µes importantes';
    }

    console.log(`\n${emoji} STATUS: ${status}`);
    console.log(`üí¨ ${message}`);

    // Recomenda√ß√µes espec√≠ficas
    this.generateRecommendations(percentage);

    // Salvar relat√≥rio
    this.saveDetailedReport(totalScore, percentage, status);

    return { totalScore, percentage, status };
  }

  generateRecommendations(percentage) {
    console.log('\nüí° RECOMENDA√á√ïES:');
    
    if (this.results.sprint1.score < 80) {
      console.log('üîß Prioridade 1: Completar corre√ß√µes cr√≠ticas do Sprint 1');
    }
    if (this.results.sprint2.score < 80) {
      console.log('üí∞ Prioridade 2: Finalizar sistema financeiro do Sprint 2');
    }
    if (this.results.sprint3.score < 80) {
      console.log('üîê Prioridade 3: Implementar seguran√ßa enterprise do Sprint 3');
    }
    if (this.results.sprint5.score < 90) {
      console.log('‚öôÔ∏è Prioridade 4: Aperfei√ßoar trading engine do Sprint 5');
    }

    if (percentage >= 90) {
      console.log('üöÄ Pr√≥ximo passo: Testes de carga e deploy em produ√ß√£o');
    } else if (percentage >= 80) {
      console.log('üîß Pr√≥ximo passo: Corre√ß√µes pontuais e testes finais');
    }
  }

  getStatusIcon(score) {
    if (score >= 90) return 'üèÜ';
    if (score >= 80) return '‚úÖ';
    if (score >= 60) return '‚ö†Ô∏è';
    return '‚ùå';
  }

  saveDetailedReport(totalScore, percentage, status) {
    const reportContent = `# RELAT√ìRIO DETALHADO - VALIDA√á√ÉO SPRINTS 1-5
## MarketBot - Auditoria T√©cnica ${this.validationMode}

**Data:** ${new Date().toLocaleString('pt-BR')}
**Modo de Valida√ß√£o:** ${this.validationMode}
**Pontua√ß√£o Total:** ${totalScore}/500 (${percentage}%)
**Status:** ${status}

## Detalhes por Sprint:

### Sprint 1 - Corre√ß√µes Cr√≠ticas (${this.results.sprint1.score}/100):
${this.results.sprint1.details.map(d => `- ${d}`).join('\n')}

### Sprint 2 - Sistema Financeiro (${this.results.sprint2.score}/100):
${this.results.sprint2.details.map(d => `- ${d}`).join('\n')}

### Sprint 3 - Seguran√ßa Enterprise (${this.results.sprint3.score}/100):
${this.results.sprint3.details.map(d => `- ${d}`).join('\n')}

### Sprint 4 - Dashboard e Monitoramento (${this.results.sprint4.score}/100):
${this.results.sprint4.details.map(d => `- ${d}`).join('\n')}

### Sprint 5 - Trading Engine Enterprise (${this.results.sprint5.score}/100):
${this.results.sprint5.details.map(d => `- ${d}`).join('\n')}

## Conclus√£o e Pr√≥ximos Passos:

${percentage >= 90 ? 
  'üèÜ Sistema em excelente estado, pronto para produ√ß√£o enterprise. Recomenda-se apenas testes de carga finais.' :
  percentage >= 80 ? 
  '‚úÖ Sistema em bom estado, pequenos ajustes necess√°rios antes da produ√ß√£o.' :
  percentage >= 70 ?
  '‚ö†Ô∏è Sistema funcional mas com melhorias necess√°rias para ambiente enterprise.' :
  '‚ùå Sistema requer corre√ß√µes importantes antes de considerar produ√ß√£o.'
}

### Arquivos Cr√≠ticos Verificados:
- **Estrutura**: ${this.validationMode === 'OFFLINE' || this.validationMode === 'HYBRID' ? 'Validada' : 'N√£o verificada'}
- **Banco de Dados**: ${this.connected ? 'Conectado e validado' : 'N√£o acess√≠vel'}
- **Servi√ßos**: ${this.results.sprint1.score + this.results.sprint2.score + this.results.sprint3.score > 200 ? 'Implementados' : 'Parcialmente implementados'}

**Relat√≥rio gerado automaticamente pelo script de valida√ß√£o MarketBot**
`;

    const filename = `RELATORIO_VALIDACAO_${this.validationMode}_${new Date().toISOString().split('T')[0]}.md`;
    fs.writeFileSync(filename, reportContent);
    console.log(`\nüìÑ Relat√≥rio detalhado salvo: ${filename}`);
  }

  // ========================================
  // EXECU√á√ÉO PRINCIPAL
  // ========================================
  async run() {
    console.log('üöÄ VALIDADOR ROBUSTO DE SPRINTS 1-5');
    console.log('===================================');
    console.log('üí° Tentativa de conex√£o online, fallback offline autom√°tico');
    
    const connected = await this.connect();
    
    try {
      if (connected) {
        await this.validateOnline();
      } else {
        this.validateOffline();
      }
    } catch (error) {
      console.error('‚ùå Erro durante valida√ß√£o:', error);
    } finally {
      await this.disconnect();
    }

    console.log('\nüéâ VALIDA√á√ÉO CONCLU√çDA!');
    console.log('üìà Verifique o relat√≥rio gerado para detalhes completos');
  }
}

// ========================================
// EXECU√á√ÉO
// ========================================
const validator = new RobustSprintValidator();
validator.run().catch(console.error);
